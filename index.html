<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>"眾籌募資智能合約</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #4caf50;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">
    <header class="bg-white shadow p-6 mb-8">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">眾籌募資智能合約 DApp</h1>
            <p class="text-lg mt-2">捐款請依個人能力貢獻 就缺您了 謝謝大家的捐款</p>
        </div>
    </header>

    <main class="container mx-auto px-4">
        <section class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-semibold mb-4">募資實時資訊</h2>
            <div class="mb-4">
                <p><strong>募款目標:</strong> 5000 wei</p>
                <p><strong>截止期限:</strong> 2024/06/30</p>
                <p><strong>已募得資金:</strong> <span id="totalFunds">0</span> wei</p>
                <p><strong>目前參與募款的人數:</strong> <span id="contributorsCount">0</span></p>
            </div>
            <label for="progressBar"><strong>實時募款完成進度:</strong></label>
            <p>&nbsp</p>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%;"></div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-semibold mb-4">捐款</h2>
            <div class="mb-4">
                <input type="number" id="contributionAmount" class="w-full p-2 border border-gray-300 rounded" placeholder="輸入捐款金額 (wei)">
            </div>
            <button onclick="contribute()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">送出捐款</button>
        </section>

        <section class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-semibold mb-4">其他功能</h2>
            <button onclick="withdraw()" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700 mb-4">提款(真的可用)</button>
            <button onclick="refund()" class="w-full bg-red-600 text-white p-2 rounded hover:bg-red-700">退款(真的可用)</button>
        </section>
    </main>

    <div id="toast" class="toast"></div>
    <div id="loading" class="loading"></div>

    <script>
        const contractABI = [
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_goal",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_deadline",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "info",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "DebugInfo",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "contribute",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "contributions",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "contributors",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "deadline",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContributorsCount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "goal",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "refund",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalFunds",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
        const contractAddress = '0xf9a756893856c20Ff9695AfB21794dEE45b33D04'; //合約地址
        let web3;
        let contract;

        window.addEventListener('load', async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    checkDeadline();
                    updateUI();
                } catch (error) {
                    console.error("你沒有權限訪問你的錢包: ", error);
                }
            } else if (window.web3) {
                web3 = new Web3(web3.currentProvider);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                checkDeadline();
                updateUI();
            } else {
                console.log('請安裝 MetaMask 錢包擴充套件');
            }
        });

        async function contribute() {
            try {
                const accounts = await web3.eth.getAccounts();
                const amount = document.getElementById('contributionAmount').value;

                if (amount <= 0) {
                    showToast('金額請大於 0，謝謝 ! 這是捐款不是提款'); 
                    return;
                }

                document.getElementById('loading').style.display = 'block';

                console.log(`正在嘗試捐款 ${amount} wei ， 捐款帳號 ${accounts[0]}`);
                await contract.methods.contribute().send({
                    from: accounts[0],
                    value: amount,
                    gas: 300000
                });

                document.getElementById('loading').style.display = 'none';
                console.log("捐款成功");
                showToast('捐款成功 非常感謝您的支持 !');
                updateUI();
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                console.error("捐款失敗: ", error);
                showToast('捐款失敗，請重新操作一次');
            }
        }

        async function withdraw() {
            try {
                const accounts = await web3.eth.getAccounts();
                const currentDate = new Date();
                const deadline = new Date('2024-06-30');

                if (currentDate < deadline) {
                    showToast('目前還不能提款，請等到截止日期後再提款');
                    return;
                }

                console.log(`正在嘗試提款到 ${accounts[0]}`);
                await contract.methods.withdraw().send({ from: accounts[0], gas: 300000 });
                console.log("提款成功");
                showToast('提款成功! 請查看您的錢包');
                updateUI();
            } catch (error) {
                console.error("提款失敗: ", error);
                showToast('提款失敗，請重新操作一次');
            }
        }

        async function refund() {
            try {
                const accounts = await web3.eth.getAccounts();
                const currentDate = new Date();
                const deadline = new Date('2024-06-30');

                if (currentDate < deadline) {
                    showToast('目前還不能退款，請等到截止日期後再退款');
                    return;
                }

                console.log(`正在嘗試退款到 ${accounts[0]}`);
                await contract.methods.refund().send({ from: accounts[0], gas: 300000 });
                console.log("退款成功");
                showToast('退款成功! 請查看您的錢包');
                updateUI();
            } catch (error) {
                console.error("退款失敗: ", error);
                showToast('退款失敗，請重新操作一次');
            }
        }

        async function updateUI() {
            try {
                const totalFundsBigInt = await contract.methods.totalFunds().call();
                const totalFunds = Number(totalFundsBigInt);
                document.getElementById('totalFunds').innerText = totalFunds;

                const contributorsCountBigInt = await contract.methods.getContributorsCount().call();
                const contributorsCount = Number(contributorsCountBigInt);
                document.getElementById('contributorsCount').innerText = contributorsCount;

                const goal = 5000;
                const progress = (totalFunds / goal) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            } catch (error) {
                console.error("ui更新錯誤: ", error);
            }
        }

        async function checkDeadline() {
            try {
                const deadlineBigInt = await contract.methods.deadline().call();
                const deadline = Number(deadlineBigInt);
                console.log("截止日期: ", new Date(deadline * 1000));
            } catch (error) {
                console.error("目前無法獲取截止日期: ", error);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    </script>
</body>

</html>
